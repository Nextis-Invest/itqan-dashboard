generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  CLIENT
  FREELANCER
}

enum MissionStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum GigStatus {
  DRAFT
  ACTIVE
  PAUSED
  DELETED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CreditType {
  PURCHASE
  MISSION_POST
  FEATURED
  REFUND
  BONUS
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

model User {
  id                      String    @id @default(cuid())
  name                    String?
  email                   String    @unique
  image                   String?
  phone                   String?
  emailVerified           DateTime?
  verificationToken       String?
  verificationTokenExpiry DateTime?
  role                    Role      @default(CLIENT)
  suspended               Boolean   @default(false)
  creditBalance           Int       @default(0)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  accounts  Account[]
  sessions  Session[]

  clientMissions    Mission[]  @relation("ClientMissions")
  freelanceMissions Mission[]  @relation("FreelanceMissions")
  proposals         Proposal[]
  reviewsWritten    Review[]   @relation("ReviewAuthor")
  reviewsReceived   Review[]   @relation("ReviewTarget")

  freelancerProfile FreelancerProfile?
  clientProfile     ClientProfile?

  gigs              Gig[]
  supportTickets    SupportTicket[]
  ticketReplies     TicketReply[]
  assignedTickets   SupportTicket[] @relation("AssignedTickets")
  ticketNotes       TicketNote[]    @relation("TicketNotes")
  creditTransactions CreditTransaction[]
  disputesOpened    Dispute[]  @relation("DisputeOpener")
  assignedDisputes  Dispute[]  @relation("AssignedDisputes")
  disputeMessages   DisputeMessage[] @relation("DisputeMessages")

  conversationParticipants ConversationParticipant[]
  chatMessages             ChatMessage[]

  certifications    Certification[]
  educations        Education[]
  notifications     Notification[]
  favorites         Favorite[]
  invitationsReceived Invitation[] @relation("InvitationsReceived")
  invitationsSent     Invitation[] @relation("InvitationsSent")
  badges              Badge[]
}

model FreelancerProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String?
  bio         String?  @db.Text
  avatar      String?
  hourlyRate  Float?
  dailyRate   Float?
  currency    String   @default("MAD")

  city        String?
  country     String   @default("MA")
  remote      Boolean  @default(true)

  skills      String[]
  category    String?
  subcategory String?
  experience  Int?

  verified    Boolean  @default(false)

  completedMissions Int    @default(0)
  avgRating         Float?

  available       Boolean   @default(true)
  availableFrom   DateTime?
  weeklyHours     Int?

  portfolioUrl String?
  linkedinUrl  String?
  githubUrl    String?
  websiteUrl   String?

  experiences  Experience[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Experience {
  id          String             @id @default(cuid())
  profileId   String
  profile     FreelancerProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  company     String
  title       String
  description String?            @db.Text
  location    String?
  startDate   DateTime?
  endDate     DateTime?
  current     Boolean            @default(false)
  source      String?            @default("manual")
  createdAt   DateTime           @default(now())
}

model ClientProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName String?
  companySize String?
  industry    String?
  website     String?
  logo        String?

  city        String?
  country     String   @default("MA")

  verified    Boolean  @default(false)
  ice         String?

  totalMissions Int    @default(0)
  totalSpent    Float  @default(0)
  avgRating     Float?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Mission {
  id           String        @id @default(cuid())
  title        String
  description  String?       @db.Text
  budget       Float?
  budgetMin    Float?
  budgetMax    Float?
  budgetType   String?       // "FIXED" | "HOURLY"
  currency     String        @default("MAD")
  deadline     DateTime?
  duration     String?
  status       MissionStatus @default(DRAFT)
  category     String?
  subcategory  String?
  skills       String[]
  experienceLevel String?
  remote       Boolean       @default(true)
  location     String?
  featured     Boolean       @default(false)
  viewCount    Int           @default(0)

  clientId     String
  client       User          @relation("ClientMissions", fields: [clientId], references: [id])

  freelancerId String?
  freelancer   User?         @relation("FreelanceMissions", fields: [freelancerId], references: [id])

  proposals    Proposal[]
  reviews      Review[]
  conversations Conversation[]
  disputes     Dispute[]
  contract     Contract?
  invitations  Invitation[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Proposal {
  id            String         @id @default(cuid())
  missionId     String
  mission       Mission        @relation(fields: [missionId], references: [id], onDelete: Cascade)

  freelancerId  String
  freelancer    User           @relation(fields: [freelancerId], references: [id])

  message       String?        @db.Text
  price         Float
  estimatedDays Int?
  status        ProposalStatus @default(PENDING)
  contract      Contract?

  createdAt     DateTime       @default(now())
}

model Review {
  id           String   @id @default(cuid())
  missionId    String
  mission      Mission  @relation(fields: [missionId], references: [id], onDelete: Cascade)

  authorId     String
  author       User     @relation("ReviewAuthor", fields: [authorId], references: [id])

  targetUserId String
  targetUser   User     @relation("ReviewTarget", fields: [targetUserId], references: [id])

  rating       Int
  comment      String?  @db.Text

  createdAt    DateTime @default(now())

  @@unique([missionId, authorId])
}

model Gig {
  id            String    @id @default(cuid())
  freelancerId  String
  freelancer    User      @relation(fields: [freelancerId], references: [id])

  title         String
  description   String    @db.Text
  category      String
  subcategory   String?

  basicPrice    Float
  basicTitle    String    @default("Basic")
  basicDesc     String?
  standardPrice Float?
  standardTitle String    @default("Standard")
  standardDesc  String?
  premiumPrice  Float?
  premiumTitle  String    @default("Premium")
  premiumDesc   String?

  currency      String    @default("MAD")
  deliveryDays  Int       @default(7)
  skills        String[]
  images        String[]

  status        GigStatus @default(DRAFT)
  viewCount     Int       @default(0)
  orderCount    Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Conversation {
  id            String   @id @default(cuid())
  missionId     String?
  mission       Mission? @relation(fields: [missionId], references: [id])

  participants  ConversationParticipant[]
  messages      ChatMessage[]

  lastMessageAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  unreadCount    Int          @default(0)

  @@unique([conversationId, userId])
}

model ChatMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id])
  content        String       @db.Text
  type           String       @default("TEXT")
  createdAt      DateTime     @default(now())
}

model SupportTicket {
  id           String         @id @default(cuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id])
  subject      String
  message      String         @db.Text
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  category     String         @default("GENERAL")
  assignedToId String?
  assignedTo   User?          @relation("AssignedTickets", fields: [assignedToId], references: [id])
  closedAt     DateTime?
  firstReplyAt DateTime?
  replies      TicketReply[]
  notes        TicketNote[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model TicketReply {
  id        String        @id @default(cuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  message   String        @db.Text
  createdAt DateTime      @default(now())
}

model TicketNote {
  id        String        @id @default(cuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  adminId   String
  admin     User          @relation("TicketNotes", fields: [adminId], references: [id])
  content   String        @db.Text
  createdAt DateTime      @default(now())
}

model CreditTransaction {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  amount       Int
  type         CreditType
  description  String?
  referenceId  String?
  balanceAfter Int
  createdAt    DateTime   @default(now())
}

model Dispute {
  id           String        @id @default(cuid())
  missionId    String
  mission      Mission       @relation(fields: [missionId], references: [id])
  openedById   String
  openedBy     User          @relation("DisputeOpener", fields: [openedById], references: [id])
  reason       String        @db.Text
  status       DisputeStatus @default(OPEN)
  resolution   String?       @db.Text
  adminNotes   String?       @db.Text
  favoredParty String?
  resolvedAt   DateTime?
  category     String        @default("OTHER")
  priority     String        @default("MEDIUM")
  assignedToId String?
  assignedTo   User?         @relation("AssignedDisputes", fields: [assignedToId], references: [id])
  messages     DisputeMessage[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model DisputeMessage {
  id         String   @id @default(cuid())
  disputeId  String
  dispute    Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  senderId   String
  sender     User     @relation("DisputeMessages", fields: [senderId], references: [id])
  content    String   @db.Text
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
}

// ========== Phase 2/3 Models ==========

model Certification {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  issuer      String?
  issueDate   DateTime?
  expiryDate  DateTime?
  url         String?
  createdAt   DateTime  @default(now())
}

model Education {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    String
  degree    String?
  field     String?
  startYear Int?
  endYear   Int?
  createdAt DateTime @default(now())
}

model Contract {
  id                 String         @id @default(cuid())
  missionId          String         @unique
  mission            Mission        @relation(fields: [missionId], references: [id])
  proposalId         String         @unique
  proposal           Proposal       @relation(fields: [proposalId], references: [id])
  clientId           String
  freelancerId       String
  totalAmount        Float
  currency           String         @default("MAD")
  status             ContractStatus @default(PENDING)
  startDate          DateTime?
  endDate            DateTime?
  signedByClient     Boolean        @default(false)
  signedByFreelancer Boolean        @default(false)
  terms              String?        @db.Text
  milestones         Milestone[]
  payments           Payment[]
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
}

enum ContractStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  DISPUTED
}

model Milestone {
  id          String          @id @default(cuid())
  contractId  String
  contract    Contract        @relation(fields: [contractId], references: [id], onDelete: Cascade)
  title       String
  description String?         @db.Text
  amount      Float
  dueDate     DateTime?
  status      MilestoneStatus @default(PENDING)
  completedAt DateTime?
  approvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REVISION
  PAID
}

model Payment {
  id         String        @id @default(cuid())
  contractId String
  contract   Contract      @relation(fields: [contractId], references: [id])
  amount     Float
  currency   String        @default("MAD")
  fee        Float         @default(0)
  netAmount  Float
  status     PaymentStatus @default(PENDING)
  method     String?
  escrowedAt DateTime?
  releasedAt DateTime?
  externalId String?
  invoiceUrl String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

enum PaymentStatus {
  PENDING
  ESCROWED
  RELEASED
  REFUNDED
  FAILED
}

model Notification {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       String
  title      String
  body       String?
  entityType String?
  entityId   String?
  actionUrl  String?
  read       Boolean  @default(false)
  readAt     DateTime?
  createdAt  DateTime @default(now())
}

model Invitation {
  id           String           @id @default(cuid())
  missionId    String
  mission      Mission          @relation(fields: [missionId], references: [id])
  freelancerId String
  freelancer   User             @relation("InvitationsReceived", fields: [freelancerId], references: [id])
  senderId     String
  sender       User             @relation("InvitationsSent", fields: [senderId], references: [id])
  message      String?
  status       InvitationStatus @default(PENDING)
  createdAt    DateTime         @default(now())
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

model Badge {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String
  name        String
  description String?
  icon        String?
  earnedAt    DateTime @default(now())

  @@unique([userId, type])
}

model Favorite {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  freelancerId String?
  missionId    String?
  createdAt    DateTime @default(now())

  @@unique([userId, freelancerId])
  @@unique([userId, missionId])
}
